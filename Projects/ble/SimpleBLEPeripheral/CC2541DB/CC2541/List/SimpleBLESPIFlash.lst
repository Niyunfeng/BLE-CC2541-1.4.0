###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.20.2.41139 for 8051             26/Mar/2014  11:21:41 #
# Copyright 2004-2013 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#                                                                             #
#    Source file        =  E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\Source\SimpleBLESPIFlash.c     #
#    Command line       =  -f E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\b #
#                          le\SimpleBLEPeripheral\CC2541DB\..\..\config\build #
#                          Components.cfg (-DBROADCASTER_CFG=0x01             #
#                          -DOBSERVER_CFG=0x02 -DPERIPHERAL_CFG=0x04          #
#                          -DCENTRAL_CFG=0x08 -DADV_NCONN_CFG=0x01            #
#                          -DADV_CONN_CFG=0x02 -DSCAN_CFG=0x04                #
#                          -DINIT_CFG=0x08 -DADV_CFG=ADV_NCONN_CFG+ADV_CONN_C #
#                          FG -DLINK_CFG=ADV_CONN_CFG+INIT_CFG                #
#                          -DFULL_CFG=INIT_CFG+SCAN_CFG+ADV_NCONN_CFG+ADV_CON #
#                          N_CFG) -f E:\TexasInstruments\BLE-CC254x-1.4.0\Pro #
#                          jects\ble\SimpleBLEPeripheral\CC2541DB\buildConfig #
#                          .cfg (-DHOST_CONFIG=PERIPHERAL_CFG                 #
#                          -DGAP_PRIVACY_RECONNECT -DCC2541                   #
#                          -DOAD_IMAGE_VERSION=0x0000                         #
#                          "-DOAD_IMAGE_A_USER_ID='A', 'A', 'A', 'A'"         #
#                          "-DOAD_IMAGE_B_USER_ID='B', 'B', 'B', 'B'")        #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\Source\SimpleBLESPIFlash.c -D  #
#                          INT_HEAP_LEN=3074 -D HALNODEBUG -D                 #
#                          OSAL_CBTIMER_NUM_TASKS=1 -D xHAL_AES_DMA=TRUE -D   #
#                          HAL_DMA=TRUE -D POWER_SAVING -D xPLUS_BROADCASTER  #
#                          -D HAL_LCD=TRUE -D HAL_LED=TRUE -D HAL_UART=TRUE   #
#                          -D HAL_ADC=TRUE -lcN E:\TexasInstruments\BLE-CC254 #
#                          x-1.4.0\Projects\ble\SimpleBLEPeripheral\CC2541DB\ #
#                          CC2541\List\ -o E:\TexasInstruments\BLE-CC254x-1.4 #
#                          .0\Projects\ble\SimpleBLEPeripheral\CC2541DB\CC254 #
#                          1\Obj\ -e --debug --core=plain --dptr=16,1         #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\b #
#                          le\SimpleBLEPeripheral\CC2541DB\..\..\common\ -I   #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\include\ -I     #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\..\..\Component #
#                          s\hal\include\ -I E:\TexasInstruments\BLE-CC254x-1 #
#                          .4.0\Projects\ble\SimpleBLEPeripheral\CC2541DB\..\ #
#                          ..\..\..\Components\hal\target\CC2541EB\ -I        #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\..\..\Component #
#                          s\osal\include\ -I E:\TexasInstruments\BLE-CC254x- #
#                          1.4.0\Projects\ble\SimpleBLEPeripheral\CC2541DB\.. #
#                          \..\..\..\Components\services\saddr\ -I            #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\..\..\Component #
#                          s\ble\include\ -I E:\TexasInstruments\BLE-CC254x-1 #
#                          .4.0\Projects\ble\SimpleBLEPeripheral\CC2541DB\..\ #
#                          ..\..\..\Components\ble\controller\phy\ -I         #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\..\..\Component #
#                          s\ble\controller\include\ -I                       #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\..\..\Component #
#                          s\ble\hci\ -I E:\TexasInstruments\BLE-CC254x-1.4.0 #
#                          \Projects\ble\SimpleBLEPeripheral\CC2541DB\..\..\. #
#                          .\..\Components\ble\host\ -I                       #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\common\cc2540\  #
#                          -I E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\b #
#                          le\SimpleBLEPeripheral\CC2541DB\..\..\common\npi\n #
#                          pi_np\ -I E:\TexasInstruments\BLE-CC254x-1.4.0\Pro #
#                          jects\ble\SimpleBLEPeripheral\CC2541DB\..\..\Profi #
#                          les\Roles\ -I E:\TexasInstruments\BLE-CC254x-1.4.0 #
#                          \Projects\ble\SimpleBLEPeripheral\CC2541DB\..\..\P #
#                          rofiles\SimpleProfile\ -I                          #
#                          E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\..\..\Profiles\DevInf #
#                          o\ -I E:\TexasInstruments\BLE-CC254x-1.4.0\Project #
#                          s\ble\SimpleBLEPeripheral\CC2541DB\..\..\Profiles\ #
#                          Batt\ -I E:\TexasInstruments\BLE-CC254x-1.4.0\Proj #
#                          ects\ble\SimpleBLEPeripheral\CC2541DB\..\..\Profil #
#                          es\HIDDev\ -Ohz                                    #
#    List file          =  E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\CC2541\List\SimpleBLE #
#                          SPIFlash.lst                                       #
#    Object file        =  E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\ #
#                          SimpleBLEPeripheral\CC2541DB\CC2541\Obj\SimpleBLES #
#                          PIFlash.r51                                        #
#                                                                             #
#                                                                             #
###############################################################################

E:\TexasInstruments\BLE-CC254x-1.4.0\Projects\ble\SimpleBLEPeripheral\Source\SimpleBLESPIFlash.c
      1          /*
      2          CC2540 
      3          ghostyu
      4          20130204
      5          */
      6          
      7          /*
      8          说明：
      9          
     10          */
     11          //#include<ioCC2540.h>
     12          //#include"Common.h"
     13          //#include"hal_lcd.h"
     14          #include "hal_assert.h"
     15          #include "hal_board_cfg.h"
     16          #include "SimpleBLESPIFlash.h"
     17          
     18          
     19          
     20          #define XNV_STAT_CMD  0x05
     21          #define XNV_WREN_CMD  0x06
     22          #define XNV_WRPG_CMD  0x0A
     23          #define XNV_READ_CMD  0x0B
     24          #define XNV_ERASE_CMD 0xC7
     25          
     26          #define XNV_STAT_WIP  0x01
     27          
     28          
     29          /* ----------- XNV ---------- */
     30          #define XNV_SPI_BEGIN()             st(P1_3 = 0;)
     31          #define XNV_SPI_TX(x)               st(U1CSR &= ~0x02; U1DBUF = (x);)
     32          #define XNV_SPI_RX()                U1DBUF
     33          #define XNV_SPI_WAIT_RXRDY()        st(while (!(U1CSR & 0x02));)
     34          #define XNV_SPI_END()               st(P1_3 = 1;)
     35          
     36          // The TI reference design uses UART1 Alt. 2 in SPI mode.
     37          #define XNV_SPI_INIT() \
     38          st( \
     39            /* Mode select UART1 SPI Mode as master. */\
     40            U1CSR = 0; \
     41            \
     42            /* Setup for 115200 baud. */\
     43            U1GCR = 11; \
     44            U1BAUD = 216; \
     45            \
     46            /* Set bit order to MSB */\
     47            U1GCR |= BV(5); \
     48            \
     49            /* Set UART1 I/O to alternate 2 location on P1 pins. */\
     50            PERCFG |= 0x02;  /* U1CFG */\
     51            \
     52            /* Select peripheral function on I/O pins but SS is left as GPIO for separate control. */\
     53            P1SEL |= 0xE0;  /* SELP1_[7:4] */\
     54            /* P1.1,2,3: reset, LCD CS, XNV CS. */\
     55            P1SEL &= ~0x0E; \
     56            P1 |= 0x0E; \
     57            P1_1 = 0; \
     58            P1DIR |= 0x0E; \
     59            \
     60            /* Give UART1 priority over Timer3. */\
     61            P2SEL &= ~0x20;  /* PRI2P1 */\
     62            \
     63            /* When SPI config is complete, enable it. */\
     64            U1CSR |= 0x40; \
     65            /* Release XNV reset. */\
     66            P1_1 = 1; \
     67          )
     68          
     69           void xnvSPIWrite(uint8 ch)
     70          {
     71            XNV_SPI_TX(ch);
     72            XNV_SPI_WAIT_RXRDY();
     73          }
     74          
     75          void HalSPIRead(uint32 addr, uint8 *pBuf, uint16 len)
     76          {
     77          
     78            uint8 shdw = P1DIR;
     79            P1DIR |= BV(3);
     80            
     81            XNV_SPI_BEGIN();
     82            do {
     83              xnvSPIWrite(XNV_STAT_CMD);
     84            } while (XNV_SPI_RX() & XNV_STAT_WIP);
     85            XNV_SPI_END();
     86            asm("NOP"); asm("NOP");
     87          
     88            XNV_SPI_BEGIN();
     89            xnvSPIWrite(XNV_READ_CMD);
     90            xnvSPIWrite(addr >> 16);
     91            xnvSPIWrite(addr >> 8);
     92            xnvSPIWrite(addr);
     93            xnvSPIWrite(0);
     94          
     95            while (len--)
     96            {
     97              xnvSPIWrite(0);
     98              *pBuf++ = XNV_SPI_RX();
     99            }
    100            XNV_SPI_END();
    101          
    102            P1DIR = shdw;
    103          }
    104          
    105           void HalSPIWrite(uint32 addr, uint8 *pBuf, uint16 len)
    106          {
    107            uint8 cnt;
    108            uint8 shdw = P1DIR;
    109            P1DIR |= BV(3);
    110            while (len)
    111            {
    112              XNV_SPI_BEGIN();
    113              do {
    114                xnvSPIWrite(XNV_STAT_CMD);
    115              } while (XNV_SPI_RX() & XNV_STAT_WIP);
    116              XNV_SPI_END();
    117              asm("NOP"); asm("NOP");
    118          
    119              XNV_SPI_BEGIN();
    120              xnvSPIWrite(XNV_WREN_CMD);
    121              XNV_SPI_END();
    122              asm("NOP"); asm("NOP");
    123          
    124              XNV_SPI_BEGIN();
    125              xnvSPIWrite(XNV_WRPG_CMD);
    126              xnvSPIWrite(addr >> 16);
    127              xnvSPIWrite(addr >> 8);
    128              xnvSPIWrite(addr);
    129          
    130              // Can only write within any one page boundary, so prepare for next page write if bytes remain.
    131              cnt = 0 - (uint8)addr;
    132              if (cnt)
    133              {
    134                addr += cnt;
    135              }
    136              else
    137              {
    138                addr += 256;
    139              }
    140          
    141              do
    142              {
    143                xnvSPIWrite(*pBuf++);
    144                cnt--;
    145                len--;
    146              } while (len && cnt);
    147              XNV_SPI_END();
    148            }
    149            P1DIR = shdw;
    150          }
    151          
    152          void HalSPIErase()
    153          {
    154             
    155              
    156              XNV_SPI_BEGIN();
    157              do {
    158                xnvSPIWrite(XNV_STAT_CMD);
    159              } while (XNV_SPI_RX() & XNV_STAT_WIP);
    160              XNV_SPI_END();
    161              asm("NOP"); asm("NOP");
    162              
    163              XNV_SPI_BEGIN();
    164              xnvSPIWrite(XNV_WREN_CMD);
    165              XNV_SPI_END();
    166              asm("NOP"); asm("NOP");
    167              
    168              XNV_SPI_BEGIN();
    169              xnvSPIWrite(XNV_ERASE_CMD);
    170              XNV_SPI_END();
    171              asm("NOP"); asm("NOP");
    172              
    173              
    174          }
    175          
    176          /*uint8 buf[15]="123456789000000";
    177          uint8 bufrx[15];
    178          
    179          
    180          
    181          int main()
    182          {
    183            HalLcd_HW_Init();
    184            
    185            HalLcd_HW_WriteLine(HAL_LCD_LINE_1, "      CC2540EM");
    186            HalLcd_HW_WriteLine(HAL_LCD_LINE_3, "-->SPI-FLASH_TEST"); 
    187            
    188            XNV_SPI_INIT();
    189          
    190            HalSPIWrite(0x0,buf,15);
    191            HalLcd_HW_WriteLine(HAL_LCD_LINE_4, "Write:"); 
    192            HalLcd_HW_WriteLine(HAL_LCD_LINE_5, buf); 
    193            //注意，连续读写之间至少要延时800us
    194            HalHW_WaitUs(800);
    195            HalSPIRead(0x0,bufrx,15);
    196            HalLcd_HW_WriteLine(HAL_LCD_LINE_6, "Read:"); 
    197            HalLcd_HW_WriteLine(HAL_LCD_LINE_7, bufrx); 
    198            while(1);
    199          }*/

   Maximum stack usage in bytes:

   ISTACK PSTACK XSTACK Function
   ------ ------ ------ --------
       2      0      0  HalSPIErase
                          2 0  0 -> xnvSPIWrite
       1      0     24  HalSPIRead
                          0 0 20 -> xnvSPIWrite
       0      0     24  HalSPIWrite
                          0 0 20 -> xnvSPIWrite
       0      0     20  xnvSPIWrite


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       6  ??HalSPIErase?relay
       6  ??HalSPIRead?relay
       6  ??HalSPIWrite?relay
       6  ??xnvSPIWrite?relay
       8  ?Subroutine0
      50  HalSPIErase
     153  HalSPIRead
     200  HalSPIWrite
       1  P1DIR
       1  U1DBUF
       1  _A_P1
       1  _A_U1CSR
       4  __Constant_100
      11  xnvSPIWrite

 
 422 bytes in segment BANKED_CODE
  24 bytes in segment BANK_RELAYS
   4 bytes in segment SFR_AN
   4 bytes in segment XDATA_ROM_C
 
 446 bytes of CODE  memory
   0 bytes of CONST memory (+ 4 bytes shared)
   0 bytes of DATA  memory (+ 4 bytes shared)

Errors: none
Warnings: 1
